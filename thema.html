<!DOCTYPE html>
<html lang="nl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thema | PAV-O</title>
<link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700;800&display=swap" rel="stylesheet">

<style>
body{
margin:0;
font-family:'Nunito',sans-serif;
background:#f1f5f9;
color:#1e293b;
}

.container{
max-width:1200px;
margin:auto;
padding:40px 20px;
}

.topbar{
display:flex;
justify-content:space-between;
align-items:center;
margin-bottom:30px;
}

.back-btn{
background:#1f6fd6;
color:white;
padding:8px 16px;
border-radius:8px;
text-decoration:none;
font-weight:700;
}

.xp-box{
background:white;
padding:10px 18px;
border-radius:10px;
box-shadow:0 4px 12px rgba(0,0,0,0.05);
font-weight:700;
}

.header{
background:white;
padding:30px;
border-radius:16px;
margin-bottom:30px;
box-shadow:0 4px 12px rgba(0,0,0,0.05);
}

.header h1{
margin:0 0 10px 0;
}

.header p{
margin:6px 0;
color:#475569;
}

.units-grid{
display:grid;
grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
gap:20px;
}

.unit-card{
background:white;
padding:20px;
border-radius:14px;
box-shadow:0 4px 12px rgba(0,0,0,0.05);
cursor:pointer;
transition:0.2s;
}

.unit-card:hover{
transform:translateY(-4px);
}

.unit-card.locked{
opacity:0.5;
pointer-events:none;
}

.progress-bar{
height:6px;
background:#e2e8f0;
border-radius:6px;
overflow:hidden;
margin-top:10px;
}

.progress-fill{
height:100%;
background:#1f6fd6;
width:0%;
}

.finished{
text-align:center;
margin-top:40px;
}

.finished img{
max-width:200px;
}
</style>
</head>
<body>

<div class="container">

<div class="topbar">
<a href="index.html" class="back-btn">Terug naar dashboard</a>
<div class="xp-box">
XP: <span id="xpScore">0</span>
</div>
</div>

<div class="header">
<h1 id="themeTitle">Laden...</h1>
<p id="themeFocus"></p>
<p id="themeSkills"></p>
</div>

<div class="units-grid" id="unitsGrid"></div>

<div class="finished" id="finishedBox" style="display:none;">
<img src="img/images/pavobouwmascotte.png">
<p>Je hebt alle onderdelen voltooid.</p>
</div>

</div>

<script src="./firebase.js"></script>

<script>
const params = new URLSearchParams(window.location.search);
const themeId = params.get("id");

let currentUser;
let themeData;
let studentProgress = {};

async function init(){

await window.firebaseReady;

window.auth.onAuthStateChanged(async user=>{
if(!user){
window.location.href="login.html";
return;
}

currentUser = user;

const themeDoc = await window.db.collection("themes").doc(themeId).get();
if(!themeDoc.exists) return;

themeData = themeDoc.data();

document.getElementById("themeTitle").innerText = themeData.title;
document.getElementById("themeFocus").innerText = "Focus: " + (themeData.focus || "");
document.getElementById("themeSkills").innerText = "Wat oefen je: " + (themeData.skills || "");

const progressDoc = await window.db
.collection("users")
.doc(user.uid)
.collection("progress")
.doc(themeId)
.get();

if(progressDoc.exists){
studentProgress = progressDoc.data();
}

renderUnits();
calculateXP();
});
}

function renderUnits(){

const grid = document.getElementById("unitsGrid");
grid.innerHTML = "";

let completedUnits = 0;

themeData.units.forEach((unit,index)=>{

const isCompleted = studentProgress[unit.id];
if(isCompleted) completedUnits++;

const locked = index > completedUnits;

const div = document.createElement("div");
div.className = "unit-card" + (locked ? " locked" : "");

div.innerHTML = `
<h3>${unit.title}</h3>
<p>${unit.description || ""}</p>
<p>${unit.xp || 10} XP</p>
`;

div.onclick = ()=>{
openUnit(unit,index);
};

grid.appendChild(div);

});

if(completedUnits === themeData.units.length){
document.getElementById("finishedBox").style.display="block";
}
}

async function openUnit(unit,index){

alert("Hier komt de unit pagina.");

await window.db
.collection("users")
.doc(currentUser.uid)
.collection("progress")
.doc(themeId)
.set({
[unit.id]: true
},{merge:true});

studentProgress[unit.id] = true;

renderUnits();
calculateXP();
}

function calculateXP(){

let total = 0;

themeData.units.forEach(unit=>{
if(studentProgress[unit.id]){
total += unit.xp || 10;
}
});

document.getElementById("xpScore").innerText = total;
}

init();
</script>

</body>
</html>

